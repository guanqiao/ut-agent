# UT-Agent 增强开发计划

## 任务概述

优先实现两个核心增强功能：

1. **增量测试生成** - 基于Git diff仅对变更代码生成测试
2. **HTML可视化报告** - 美观的覆盖率报告生成

***

## 一、增量测试生成模块

### 1.1 功能设计

**核心能力**:

* 分析Git diff识别变更的方法和代码块

* 建立源文件与测试文件的映射关系

* 智能合并：保留手工修改的测试代码

* 支持三种变更场景：

  * 新增方法 → 生成新测试

  * 修改方法 → 更新现有测试

  * 删除方法 → 标记废弃测试

**技术方案**:

```
src/ut_agent/tools/
├── git_analyzer.py      # Git差异分析
├── change_detector.py   # 变更检测
└── test_mapper.py       # 测试文件映射
```

### 1.2 实现步骤

**步骤1: Git差异分析模块** (`git_analyzer.py`)

* 使用GitPython库执行git diff

* 解析diff输出，提取变更的文件、行号范围

* 识别变更类型（新增/修改/删除）

**步骤2: 变更方法检测** (`change_detector.py`)

* 结合AST解析，定位变更的具体方法/函数

* 生成变更摘要（方法签名、变更内容）

**步骤3: 测试文件映射** (`test_mapper.py`)

* 建立源文件 ↔ 测试文件的映射规则

* 解析现有测试文件，识别已测试的方法

* 检测测试文件中的手工修改（通过注释标记或哈希校验）

**步骤4: 增量生成策略** (修改 `nodes.py`)

* 新增节点：`detect_changes_node` - 检测变更

* 新增节点：`map_test_files_node` - 映射测试文件

* 修改 `generate_tests_node` - 仅生成变更部分的测试

* 新增节点：`merge_tests_node` - 智能合并测试

**步骤5: CLI/UI集成**

* 添加 `--incremental` / `-i` 参数

* Web UI添加增量生成选项

### 1.3 数据结构扩展

```python
# state.py 新增
class CodeChange(BaseModel):
    file_path: str
    change_type: str  # "added", "modified", "deleted"
    method_name: Optional[str]
    line_range: Tuple[int, int]
    diff_content: str

class TestMapping(BaseModel):
    source_file: str
    test_file: str
    method_mappings: Dict[str, str]  # 方法名 -> 测试方法名
    last_generated: datetime
    has_manual_changes: bool
```

***

## 二、HTML可视化报告模块

### 2.1 功能设计

**报告内容**:

* 覆盖率概览仪表盘（总体覆盖率、趋势图）

* 文件级覆盖率列表（可排序、筛选）

* 代码高亮显示（已覆盖/未覆盖/部分覆盖）

* 缺口代码高亮和跳转

* 历史报告对比

* 导出功能（PDF、JSON）

**技术方案**:

```
src/ut_agent/reporting/
├── __init__.py
├── html_generator.py    # HTML报告生成器
├── templates/           # Jinja2模板
│   ├── base.html
│   ├── dashboard.html
│   ├── file_detail.html
│   └── components/
├── static/              # CSS/JS资源
│   ├── css/
│   └── js/
└── assets/              # 图表库
```

### 2.2 实现步骤

**步骤1: 报告数据聚合** (`report_data.py`)

* 整合覆盖率报告、缺口分析、历史数据

* 生成报告数据结构

**步骤2: HTML生成器** (`html_generator.py`)

* 使用Jinja2模板引擎

* 生成响应式HTML页面

* 集成Chart.js绘制趋势图

**步骤3: 模板设计**

* `base.html` - 基础布局

* `dashboard.html` - 概览仪表盘

* `file_detail.html` - 文件详情（代码高亮）

**步骤4: 静态资源**

* 内联CSS样式（Tailwind-like）

* 内联Chart.js（避免外部依赖）

* 代码高亮样式

**步骤5: CLI/UI集成**

* 添加 `--report` / `-r` 参数生成报告

* Web UI集成报告查看

### 2.3 报告界面设计

```
┌─────────────────────────────────────────────────────────────┐
│  UT-Agent 覆盖率报告                    [导出PDF] [导出JSON]  │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐       │
│  │ 总体覆盖  │ │ 行覆盖   │ │ 分支覆盖  │ │ 方法覆盖  │       │
│  │  78.5%   │ │  82.3%   │ │  71.2%   │ │  85.6%   │       │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘       │
├─────────────────────────────────────────────────────────────┤
│  [覆盖率趋势图]                                              │
├─────────────────────────────────────────────────────────────┤
│  文件列表 (可排序/筛选)                                       │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 文件名          │ 行覆盖 │ 分支覆盖 │ 状态          │   │
│  │ UserService.java │ 85%   │ 72%     │ 🟡 需改进    │   │
│  │ OrderController  │ 92%   │ 88%     │ 🟢 良好      │   │
│  │ ...              │ ...   │ ...     │ ...          │   │
│  └─────────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────────┤
│  未覆盖代码缺口 (Top 10)                                      │
└─────────────────────────────────────────────────────────────┘
```

***

## 三、开发任务清单

### Phase 1: 增量测试生成 (预计1.5周)

| 任务                  | 优先级 | 预估时间 | 依赖  |
| ------------------- | --- | ---- | --- |
| 1.1 实现Git差异分析模块     | P0  | 2天   | 无   |
| 1.2 实现变更方法检测        | P0  | 2天   | 1.1 |
| 1.3 实现测试文件映射        | P0  | 2天   | 1.2 |
| 1.4 实现智能合并逻辑        | P0  | 2天   | 1.3 |
| 1.5 集成到LangGraph工作流 | P0  | 1天   | 1.4 |
| 1.6 CLI/UI参数集成      | P1  | 1天   | 1.5 |
| 1.7 编写单元测试          | P0  | 1天   | 全部  |

### Phase 2: HTML报告生成 (预计1.5周)

| 任务                 | 优先级 | 预估时间 | 依赖  |
| ------------------ | --- | ---- | --- |
| 2.1 设计报告数据模型       | P0  | 1天   | 无   |
| 2.2 实现HTML生成器核心    | P0  | 2天   | 2.1 |
| 2.3 开发Dashboard模板  | P0  | 2天   | 2.2 |
| 2.4 开发文件详情模板(代码高亮) | P0  | 2天   | 2.3 |
| 2.5 集成趋势图和图表       | P1  | 1天   | 2.4 |
| 2.6 CLI/UI参数集成     | P1  | 1天   | 2.5 |
| 2.7 编写单元测试         | P0  | 1天   | 全部  |

***

## 四、文件变更计划

### 新增文件

```
src/ut_agent/
├── tools/
│   ├── git_analyzer.py          # Git差异分析
│   ├── change_detector.py       # 变更检测
│   └── test_mapper.py           # 测试文件映射
└── reporting/
    ├── __init__.py
    ├── html_generator.py        # HTML报告生成器
    ├── report_data.py           # 报告数据聚合
    └── templates/
        ├── base.html
        ├── dashboard.html
        └── file_detail.html
```

### 修改文件

```
src/ut_agent/
├── graph/
│   ├── state.py                 # 添加CodeChange/TestMapping模型
│   ├── nodes.py                 # 添加增量生成节点
│   └── graph.py                 # 更新工作流图
├── main.py                      # 添加CLI参数
└── ui/app.py                    # 添加UI选项
```

***

## 五、关键实现细节

### 5.1 智能合并策略

```python
def merge_tests(existing_test: str, new_test: str, method_mapping: dict) -> str:
    """
    合并策略:
    1. 检测手工修改标记 (// MANUAL: ...)
    2. 保留手工修改的测试方法
    3. 更新自动生成的测试方法
    4. 添加新增的测试方法
    """
```

### 5.2 代码高亮实现

```python
def generate_highlighted_code(file_path: str, coverage_data: dict) -> str:
    """
    生成带覆盖率标记的HTML代码:
    - 绿色: 已覆盖
    - 红色: 未覆盖
    - 黄色: 部分覆盖(分支)
    """
```

***

## 六、验收标准

### 增量测试生成

* [ ] 能准确识别Git diff中的变更方法

* [ ] 仅生成变更部分的测试，生成时间减少50%+

* [ ] 不覆盖手工修改的测试代码

* [ ] 支持新增/修改/删除三种场景

### HTML报告

* [ ] 报告可在浏览器正常打开

* [ ] 包含覆盖率仪表盘和趋势图

* [ ] 代码高亮显示覆盖状态

* [ ] 支持导出PDF/JSON

***

## 七、风险与应对

| 风险            | 可能性 | 影响 | 应对                      |
| ------------- | --- | -- | ----------------------- |
| GitPython依赖问题 | 低   | 中  | 使用subprocess调用git命令作为备选 |
| 复杂diff解析      | 中   | 中  | 分阶段实现，先支持常见场景           |
| 测试合并冲突        | 中   | 高  | 提供冲突提示和手动解决选项           |
| HTML报告兼容性     | 低   | 低  | 使用标准HTML5/CSS3          |

***

**计划制定日期**: 2026-02-16\
**预计完成时间**: 3周\
**下次评审**: 每任务完成后
