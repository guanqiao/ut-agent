## 架构优化重构计划 (第二阶段)

### 一、P0 高优先级任务

#### 1. test_generator.py 重构
- **问题**: 使用同步 `llm.invoke()` 调用，未使用 AsyncLLMCaller
- **方案**: 
  - 创建 `TestGenerator` 类，注入 `AsyncLLMCaller`
  - 将同步函数改为异步 `generate_java_test_async()`
  - 使用 `PromptTemplateLoader` 替代硬编码 Prompt

#### 2. nodes.py 重构
- **问题**: 未使用 ErrorHandler 和 AsyncLLMCaller
- **方案**:
  - 集成 `ErrorHandler` 进行统一错误处理
  - 使用 `AsyncLLMCaller` 替代直接 LLM 调用
  - 使用 `AsyncParallelProcessor` 优化并行处理

### 二、P1 中优先级任务

#### 3. 架构整合
- **问题**: Agent 和 Graph 模块存在重复实现
- **方案**: 创建 `UnifiedTestWorkflow` 统一工作流管理

#### 4. 依赖注入容器
- **问题**: 直接导入 `settings`，难以测试
- **方案**: 实现 `DependencyContainer` 依赖注入容器

### 三、P2 低优先级任务

#### 5. config.py 重构
- **问题**: 配置项分散，无分组
- **方案**: 使用 Pydantic 嵌套模型分组配置

#### 6. Prompt 模板迁移
- **问题**: 硬编码 Prompt 模板
- **方案**: 迁移到外部 YAML 文件

### 预估工作量
- P0 任务: 4 天
- P1 任务: 4 天  
- P2 任务: 3 天

### 开发方式
- TDD 方式，先测试后实现
- 增量重构，确保测试通过