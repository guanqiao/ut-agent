# 开发计划：测试数据生成器与性能优化

## 一、任务概述

| 功能模块 | 优先级 | 依赖关系 |
|---------|--------|---------|
| 测试数据生成器 - 边界值生成 | 高 | 无 |
| 性能优化 - AST缓存 | 高 | 无 |
| 性能优化 - 并行生成 | 中 | AST缓存 |

---

## 二、测试数据生成器 - 基于类型自动生成边界值

### 2.1 功能描述
创建智能测试数据生成器，根据参数类型自动生成边界值测试数据，减少对 LLM 的依赖。

### 2.2 实现方案

**新建文件**: `src/ut_agent/tools/test_data_generator.py`

```python
# 核心类设计
class TestDataGenerator:
    - generate_boundary_values(type_info) -> List[Any]
    - generate_primitive_values(type_name) -> Dict[str, Any]
    - generate_collection_values(element_type) -> List[Any]
    - generate_custom_object(class_info) -> Dict[str, Any]
```

**支持的类型边界值**:

| 类型 | 边界值 |
|------|--------|
| int/Integer | MIN, MAX, 0, -1, 1 |
| float/Double | MIN, MAX, NaN, Infinity, 0.0 |
| String | "", " ", "very long...", null, special chars |
| boolean | true, false |
| List/Array | [], [one], [many], null |
| Map/Object | {}, {one entry}, null |

### 2.3 集成点
- 修改 `test_generator.py`，在 Prompt 中注入预生成的边界值
- 与 `code_analyzer.py` 的参数类型解析联动

### 2.4 完成标准
- [ ] 支持 Java/TypeScript 基本类型边界值生成
- [ ] 支持集合类型边界值生成
- [ ] 单元测试覆盖率 ≥ 90%
- [ ] 集成到现有测试生成流程

---

## 三、性能优化 - AST缓存

### 3.1 功能描述
实现 AST 解析结果缓存，避免重复解析相同文件，提升代码分析速度。

### 3.2 实现方案

**新建文件**: `src/ut_agent/tools/ast_cache.py`

```python
# AST 缓存管理器
class ASTCacheManager:
    - get_or_parse(file_path, language) -> Tree
    - invalidate(file_path) -> None
    - clear() -> None
    - get_cache_stats() -> Dict
```

**缓存策略**:
- 缓存位置: `.ut-agent/ast_cache/`
- 缓存键: 文件路径 + 内容哈希
- 缓存格式: 序列化的 tree-sitter AST
- 失效策略: 文件修改时自动失效

### 3.3 迁移到 tree-sitter
- 将 `code_analyzer.py` 从正则表达式迁移到 tree-sitter
- 利用已安装的 `tree-sitter-java`, `tree-sitter-typescript`

### 3.4 完成标准
- [ ] AST 缓存读写功能正常
- [ ] 文件变更检测自动失效缓存
- [ ] 代码分析速度提升 ≥ 50%
- [ ] 单元测试覆盖率 ≥ 90%

---

## 四、性能优化 - 并行生成

### 4.1 功能描述
实现多文件并行测试生成，充分利用多核 CPU 资源。

### 4.2 实现方案

**修改文件**: `src/ut_agent/graph/nodes.py`

```python
# 并行测试生成
async def generate_tests_parallel(state: GraphState) -> Dict:
    - 使用 asyncio.gather() 并行处理多个文件
    - 控制并发数 (默认 CPU 核心数)
    - 支持进度追踪
```

**并行策略**:
- 文件级并行: 不同文件同时生成测试
- 方法级并行: 同一文件的不同方法并行生成（可选）
- LLM 请求批处理: 合并多个小请求

### 4.3 完成标准
- [ ] 多文件并行生成功能正常
- [ ] 支持并发数配置
- [ ] 生成速度提升 ≥ 2x (多文件场景)
- [ ] 单元测试覆盖率 ≥ 85%

---

## 五、文件变更清单

| 操作 | 文件路径 |
|------|---------|
| 新建 | `src/ut_agent/tools/test_data_generator.py` |
| 新建 | `src/ut_agent/tools/ast_cache.py` |
| 修改 | `src/ut_agent/tools/code_analyzer.py` |
| 修改 | `src/ut_agent/tools/test_generator.py` |
| 修改 | `src/ut_agent/graph/nodes.py` |
| 新建 | `tests/test_test_data_generator.py` |
| 新建 | `tests/test_ast_cache.py` |

---

## 六、版本与日期

- **版本号**: v1.1.0
- **计划日期**: 2026-02-16
- **预估工期**: 3-5 个工作日